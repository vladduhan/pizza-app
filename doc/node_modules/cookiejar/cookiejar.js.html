<!DOCTYPE html>
<html>
<head>
  <title>cookiejar.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules\\cookiejar\\cookiejar.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>cookiejar.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-comment">/* jshint node: true */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CookieAccessInfo</span>(<span class="hljs-params">domain, path, secure, script</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> CookieAccessInfo) {
            <span class="hljs-keyword">this</span>.domain = domain || <span class="hljs-literal">undefined</span>;
            <span class="hljs-keyword">this</span>.path = path || <span class="hljs-string">"/"</span>;
            <span class="hljs-keyword">this</span>.secure = !!secure;
            <span class="hljs-keyword">this</span>.script = !!script;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CookieAccessInfo(domain, path, secure, script);
    }
    exports.CookieAccessInfo = CookieAccessInfo;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Cookie</span>(<span class="hljs-params">cookiestr, request_domain, request_path</span>) </span>{
        <span class="hljs-keyword">if</span> (cookiestr <span class="hljs-keyword">instanceof</span> Cookie) {
            <span class="hljs-keyword">return</span> cookiestr;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Cookie) {
            <span class="hljs-keyword">this</span>.name = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">this</span>.value = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">this</span>.expiration_date = <span class="hljs-literal">Infinity</span>;
            <span class="hljs-keyword">this</span>.path = <span class="hljs-built_in">String</span>(request_path || <span class="hljs-string">"/"</span>);
            <span class="hljs-keyword">this</span>.explicit_path = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">this</span>.domain = request_domain || <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">this</span>.explicit_domain = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">this</span>.secure = <span class="hljs-literal">false</span>; <span class="hljs-comment">//how to define default?</span>
            <span class="hljs-keyword">this</span>.noscript = <span class="hljs-literal">false</span>; <span class="hljs-comment">//httponly</span>
            <span class="hljs-keyword">if</span> (cookiestr) {
                <span class="hljs-keyword">this</span>.parse(cookiestr, request_domain, request_path);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Cookie(cookiestr, request_domain, request_path);
    }
    exports.Cookie = Cookie;

    Cookie.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toString</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> str = [<span class="hljs-keyword">this</span>.name + <span class="hljs-string">"="</span> + <span class="hljs-keyword">this</span>.value];
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.expiration_date !== <span class="hljs-literal">Infinity</span>) {
            str.push(<span class="hljs-string">"expires="</span> + (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-keyword">this</span>.expiration_date)).toGMTString());
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.domain) {
            str.push(<span class="hljs-string">"domain="</span> + <span class="hljs-keyword">this</span>.domain);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.path) {
            str.push(<span class="hljs-string">"path="</span> + <span class="hljs-keyword">this</span>.path);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.secure) {
            str.push(<span class="hljs-string">"secure"</span>);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.noscript) {
            str.push(<span class="hljs-string">"httponly"</span>);
        }
        <span class="hljs-keyword">return</span> str.join(<span class="hljs-string">"; "</span>);
    };

    Cookie.prototype.toValueString = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toValueString</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name + <span class="hljs-string">"="</span> + <span class="hljs-keyword">this</span>.value;
    };

    <span class="hljs-keyword">var</span> cookie_str_splitter = <span class="hljs-regexp">/[:](?=\s*[a-zA-Z0-9_\-]+\s*[=])/g</span>;
    Cookie.prototype.parse = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span>(<span class="hljs-params">str, request_domain, request_path</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Cookie) {
            <span class="hljs-keyword">var</span> parts = str.split(<span class="hljs-string">";"</span>).filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
                    <span class="hljs-keyword">return</span> !!value;
                }),
                pair = parts[<span class="hljs-number">0</span>].match(<span class="hljs-regexp">/([^=]+)=([\s\S]*)/</span>),
                key = pair[<span class="hljs-number">1</span>],
                value = pair[<span class="hljs-number">2</span>],
                i;
            <span class="hljs-keyword">this</span>.name = key;
            <span class="hljs-keyword">this</span>.value = value;

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; parts.length; i += <span class="hljs-number">1</span>) {
                pair = parts[i].match(<span class="hljs-regexp">/([^=]+)(?:=([\s\S]*))?/</span>);
                key = pair[<span class="hljs-number">1</span>].trim().toLowerCase();
                value = pair[<span class="hljs-number">2</span>];
                <span class="hljs-keyword">switch</span> (key) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"httponly"</span>:
                    <span class="hljs-keyword">this</span>.noscript = <span class="hljs-literal">true</span>;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"expires"</span>:
                    <span class="hljs-keyword">this</span>.expiration_date = value ?
                            <span class="hljs-built_in">Number</span>(<span class="hljs-built_in">Date</span>.parse(value)) :
                            <span class="hljs-literal">Infinity</span>;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"path"</span>:
                    <span class="hljs-keyword">this</span>.path = value ?
                            value.trim() :
                            <span class="hljs-string">""</span>;
                    <span class="hljs-keyword">this</span>.explicit_path = <span class="hljs-literal">true</span>;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"domain"</span>:
                    <span class="hljs-keyword">this</span>.domain = value ?
                            value.trim() :
                            <span class="hljs-string">""</span>;
                    <span class="hljs-keyword">this</span>.explicit_domain = !!<span class="hljs-keyword">this</span>.domain;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"secure"</span>:
                    <span class="hljs-keyword">this</span>.secure = <span class="hljs-literal">true</span>;
                    <span class="hljs-keyword">break</span>;
                }
            }

            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.explicit_path) {
               <span class="hljs-keyword">this</span>.path = request_path || <span class="hljs-string">"/"</span>;
            }
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.explicit_domain) {
               <span class="hljs-keyword">this</span>.domain = request_domain;
            }

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Cookie().parse(str, request_domain, request_path);
    };

    Cookie.prototype.matches = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">matches</span>(<span class="hljs-params">access_info</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.noscript &amp;&amp; access_info.script ||
                <span class="hljs-keyword">this</span>.secure &amp;&amp; !access_info.secure ||
                !<span class="hljs-keyword">this</span>.collidesWith(access_info)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    };

    Cookie.prototype.collidesWith = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">collidesWith</span>(<span class="hljs-params">access_info</span>) </span>{
        <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">this</span>.path &amp;&amp; !access_info.path) || (<span class="hljs-keyword">this</span>.domain &amp;&amp; !access_info.domain)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.path &amp;&amp; access_info.path.indexOf(<span class="hljs-keyword">this</span>.path) !== <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.explicit_path &amp;&amp; access_info.path.indexOf( <span class="hljs-keyword">this</span>.path ) !== <span class="hljs-number">0</span>) {
           <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">var</span> access_domain = access_info.domain &amp;&amp; access_info.domain.replace(<span class="hljs-regexp">/^[\.]/</span>,<span class="hljs-string">''</span>);
        <span class="hljs-keyword">var</span> cookie_domain = <span class="hljs-keyword">this</span>.domain &amp;&amp; <span class="hljs-keyword">this</span>.domain.replace(<span class="hljs-regexp">/^[\.]/</span>,<span class="hljs-string">''</span>);
        <span class="hljs-keyword">if</span> (cookie_domain === access_domain) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span> (cookie_domain) {
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.explicit_domain) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// we already checked if the domains were exactly the same</span>
            }
            <span class="hljs-keyword">var</span> wildcard = access_domain.indexOf(cookie_domain);
            <span class="hljs-keyword">if</span> (wildcard === <span class="hljs-number">-1</span> || wildcard !== access_domain.length - cookie_domain.length) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CookieJar</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> cookies, cookies_list, collidable_cookie;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> CookieJar) {
            cookies = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>); <span class="hljs-comment">//name: [Cookie]</span>

            <span class="hljs-keyword">this</span>.setCookie = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setCookie</span>(<span class="hljs-params">cookie, request_domain, request_path</span>) </span>{
                <span class="hljs-keyword">var</span> remove, i;
                cookie = <span class="hljs-keyword">new</span> Cookie(cookie, request_domain, request_path);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Delete the cookie if the set is past the current time</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                remove = cookie.expiration_date &lt;= <span class="hljs-built_in">Date</span>.now();
                <span class="hljs-keyword">if</span> (cookies[cookie.name] !== <span class="hljs-literal">undefined</span>) {
                    cookies_list = cookies[cookie.name];
                    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; cookies_list.length; i += <span class="hljs-number">1</span>) {
                        collidable_cookie = cookies_list[i];
                        <span class="hljs-keyword">if</span> (collidable_cookie.collidesWith(cookie)) {
                            <span class="hljs-keyword">if</span> (remove) {
                                cookies_list.splice(i, <span class="hljs-number">1</span>);
                                <span class="hljs-keyword">if</span> (cookies_list.length === <span class="hljs-number">0</span>) {
                                    <span class="hljs-keyword">delete</span> cookies[cookie.name];
                                }
                                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                            }
                            cookies_list[i] = cookie;
                            <span class="hljs-keyword">return</span> cookie;
                        }
                    }
                    <span class="hljs-keyword">if</span> (remove) {
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                    }
                    cookies_list.push(cookie);
                    <span class="hljs-keyword">return</span> cookie;
                }
                <span class="hljs-keyword">if</span> (remove) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                cookies[cookie.name] = [cookie];
                <span class="hljs-keyword">return</span> cookies[cookie.name];
            };
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>returns a cookie</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">this</span>.getCookie = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCookie</span>(<span class="hljs-params">cookie_name, access_info</span>) </span>{
                <span class="hljs-keyword">var</span> cookie, i;
                cookies_list = cookies[cookie_name];
                <span class="hljs-keyword">if</span> (!cookies_list) {
                    <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; cookies_list.length; i += <span class="hljs-number">1</span>) {
                    cookie = cookies_list[i];
                    <span class="hljs-keyword">if</span> (cookie.expiration_date &lt;= <span class="hljs-built_in">Date</span>.now()) {
                        <span class="hljs-keyword">if</span> (cookies_list.length === <span class="hljs-number">0</span>) {
                            <span class="hljs-keyword">delete</span> cookies[cookie.name];
                        }
                        <span class="hljs-keyword">continue</span>;
                    }

                    <span class="hljs-keyword">if</span> (cookie.matches(access_info)) {
                        <span class="hljs-keyword">return</span> cookie;
                    }
                }
            };
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>returns a list of cookies</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">this</span>.getCookies = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCookies</span>(<span class="hljs-params">access_info</span>) </span>{
                <span class="hljs-keyword">var</span> matches = [], cookie_name, cookie;
                <span class="hljs-keyword">for</span> (cookie_name <span class="hljs-keyword">in</span> cookies) {
                    cookie = <span class="hljs-keyword">this</span>.getCookie(cookie_name, access_info);
                    <span class="hljs-keyword">if</span> (cookie) {
                        matches.push(cookie);
                    }
                }
                matches.toString = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toString</span>(<span class="hljs-params"></span>) </span>{
                    <span class="hljs-keyword">return</span> matches.join(<span class="hljs-string">":"</span>);
                };
                matches.toValueString = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toValueString</span>(<span class="hljs-params"></span>) </span>{
                    <span class="hljs-keyword">return</span> matches.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{
                        <span class="hljs-keyword">return</span> c.toValueString();
                    }).join(<span class="hljs-string">';'</span>);
                };
                <span class="hljs-keyword">return</span> matches;
            };

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CookieJar();
    }
    exports.CookieJar = CookieJar;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>returns list of cookies that were set correctly. Cookies that are expired and removed are not returned.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    CookieJar.prototype.setCookies = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setCookies</span>(<span class="hljs-params">cookies, request_domain, request_path</span>) </span>{
        cookies = <span class="hljs-built_in">Array</span>.isArray(cookies) ?
                cookies :
                cookies.split(cookie_str_splitter);
        <span class="hljs-keyword">var</span> successful = [],
            i,
            cookie;
        cookies = cookies.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>)</span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Cookie(item, request_domain, request_path);
        });
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; cookies.length; i += <span class="hljs-number">1</span>) {
            cookie = cookies[i];
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.setCookie(cookie, request_domain, request_path)) {
                successful.push(cookie);
            }
        }
        <span class="hljs-keyword">return</span> successful;
    };
}());

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
